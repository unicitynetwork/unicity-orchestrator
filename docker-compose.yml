version: "3.9"

services:
  surrealdb:
    image: surrealdb/surrealdb:latest
    command: >
      start
      --log info
      --user ${SURREALDB_USERNAME:-root}
      --pass ${SURREALDB_PASSWORD:-root}
      file:/data/surreal.db
    ports:
      - "8000:8000"
    environment:
      # These are for Surreal itself; orchestrator will use the same values.
      - SURREALDB_USERNAME=${SURREALDB_USERNAME:-root}
      - SURREALDB_PASSWORD=${SURREALDB_PASSWORD:-root}
    volumes:
      - surreal-data:/data

  orchestrator:
    build: .
    depends_on:
      - surrealdb
    environment:
      # Tell the orchestrator how to reach SurrealDB *inside* the compose network
      - SURREALDB_URL=ws://surrealdb:8000
      - SURREALDB_NAMESPACE=unicity
      - SURREALDB_DATABASE=orchestrator
      - SURREALDB_USERNAME=${SURREALDB_USERNAME:-root}
      - SURREALDB_PASSWORD=${SURREALDB_PASSWORD:-root}

      # MCP HTTP bind inside container
      - MCP_BIND=0.0.0.0:3942

      # Logging
      - RUST_LOG=info,unicity_orchestrator=info
    ports:
      # Expose MCP HTTP to the host (for Inspector / client)
      - "3942:3942"
    command: >
      sh -c "unicity-orchestrator mcp-http
             --bind ${MCP_BIND}
             --db-url ${SURREALDB_URL}"

volumes:
  surreal-data:
